<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Exam timer</title>
    <script>
        // Usage: See README.md or https://github.com/doersino/exam-timer/.
        var duration = 90;  // in minutes

        var remainingLabel = "m";
        var remainingAboveContent = "";
        var remainingBelowContent = "REMAINING";
        var startContent = "START";
        var endContent = "END";
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            background-color: black;
            font-family: Helvetica, Arial, sans-serif;
            font-size: 28px;
            color: white;
        }
        body {
            display: flex;
        }
        .infos {
            flex: 0.6;
            padding: 1.5rem;
            height: 100vh;
            overflow-y: scroll;
            background-color: #222;
        }
        h1 {
            font-size: 1.5em;
            margin-bottom: 0.666em;
        }
        ul {
            list-style: none;
        }
        li:before {
            content: "–";
            padding-right: 0.5em;
        }
        li {
            padding-left: 1em;
            text-indent: -1em;
            line-height: 1.5em;
            margin-bottom: 0.5em;
        }
        .timer {
            flex: 0.4;
            height: 100vh;
            padding: 1.5rem;
        }
        svg {
            width: 100%;
            height: 100%;
            font-family: Helvetica, Arial, sans-serif;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>
    <section class="infos">
        <span class="before">Welcome to the</span>
        <header>
            <h1>Studiology 101 exam</h1>
        </header>
        <ul>
            <li class="before"><strong>On your desks</strong>: your student id, a pen, snacks/beverages/liquor.</li>
            <li class="before">Put your phones, smartwatches and tricorders away.</li>
            <li class="before during homestretch">Unsuccessful cheating attempts will result in a failing grade and gossip in the faculty lounge. Successful cheating is rewarded with good grades.</li>
            <li class="before">Good luck. <strong>You'll need it.</strong></li>
            <li class="during">If you <strong>require more sheets of paper</strong>, raise your hand. Our paper butler ("teaching assistant" is so old-fashioned!) will at once present you with a selection of the finest paper and paper byproducts.</li>
            <li class="homestretch">Whoever noisily packs their belongings, lazily shuffles to the front to hand in their exam, and sprints out of the room during the final 10 minutes will be cursed by the remaining unfortunates.</li>
            <li class="after">It's gone. It's done.</li>
            <li class="after">Yes, Mister Frodo. It's over now.</li>
            <li class="after">I can see the Shire... the Brandywine River... Bag End... Gandalf's fireworks... the lights in the Party Tree.</li>
        </ul>
    </section>
    <section class="timer">
        <svg id="timer">
            <path id="spinner-background" fill="none" stroke="#555" />
            <path id="spinner" fill="none" stroke="white" />
            <text id="remaining" fill="white" text-anchor="middle" alignment-baseline="middle"></text>
            <text id="remaining-above" fill="white" text-anchor="middle" alignment-baseline="middle"></text>
            <text id="remaining-below" fill="white" text-anchor="middle" alignment-baseline="middle"></text>
            <path id="start-end-circle" fill="none" stroke="none" />
            <text id="start-end" fill="white" text-anchor="middle">
                <textPath id="start-end-path" xlink:href="#start-end-circle"></textPath>
            </text>
        </svg>
    </section>
    <script>

        // via https://stackoverflow.com/a/18473154
        function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
            var angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;

            return {
                x: centerX + (radius * Math.cos(angleInRadians)),
                y: centerY + (radius * Math.sin(angleInRadians))
            };
        }

        // via https://stackoverflow.com/a/18473154
        function describeArc(x, y, radius, startAngle, endAngle) {
            var start = polarToCartesian(x, y, radius, endAngle);
            var end = polarToCartesian(x, y, radius, startAngle);

            var largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";

            var d = [
                "M", start.x, start.y,
                "A", radius, radius, 0, largeArcFlag, 0, end.x, end.y
            ].join(" ");

            return d;
        }

        var running = false;
        var s;
        var e;

        // resume timer after a reload
        if (window.location.hash) {
            s = new Date(parseInt(window.location.hash.substring(1)) * 1000);
            e = new Date(s.getTime() + duration*60000);

            running = true;
        }

        // space bar => start timer
        document.body.onkeyup = function(event) {
            if (!running && event.keyCode == 32) {
                s = new Date();
                e = new Date(s.getTime() + duration*60000);

                running = true;
                window.location.hash = Math.round(s.getTime() / 1000);
            }
        };

        // hide cursor once it hasn't been moved for 2s
        // based on https://stackoverflow.com/a/31798987
        var cursorTimeout;
        document.body.onmousemove = function() {
            if (document.body.style.cursor != "none") {
                if (cursorTimeout) {
                    clearTimeout(cursorTimeout);
                }
            } else {
                document.body.style.cursor = "auto";
            }

            cursorTimeout = setTimeout(function() {
                document.body.style.cursor = "none";
            }, 2000);
        };

        // run the following 10 times a second. yes, much of this could be run
        // only once, but none of it is massively resource-intensive and keeping
        // it this way automatically adjusts the size of everything in case the
        // browser window is resized or the scaling factor is changed while the
        // timer is running
        setInterval(function() {
            var w = document.getElementById("timer").clientWidth;
            var h = document.getElementById("timer").clientHeight;
            var size = Math.min(h, w);

            // compute line thicknesses and font sizes
            var spinnerArcThickness = size / 25;
            var spinnerBackgroundArcThickness = size / 60;
            var remainingFontSize = size / 5;
            var remainingAboveFontSize = size / 15;
            var remainingBelowFontSize = size / 15;
            var startEndFontSize = size / 25;

            // define spinner/arc position
            var spinnerRadius = size / 2 - spinnerArcThickness / 2;
            var spinnerX = w / 2;
            var spinnerY = h / 2;

            // define position of labels
            var remainingY = spinnerY;
            var remainingAboveY = remainingY - .7 * (remainingFontSize + remainingAboveFontSize);
            var remainingBelowY = remainingY + .6 * (remainingFontSize + remainingBelowFontSize);
            // weird: the spacing's off if this ^ is the same as the other one

            // shift labels if only one is set
            if (remainingAboveContent && !remainingBelowContent) {
                remainingY += .25 * (remainingFontSize + remainingAboveFontSize);
                remainingAboveY += .25 * (remainingFontSize + remainingAboveFontSize);
            }
            if (!remainingAboveContent && remainingBelowContent) {
                remainingY -= .25 * (remainingFontSize + remainingAboveFontSize);
                remainingBelowY -= .25 * (remainingFontSize + remainingAboveFontSize);
            };

            // compute radius of arc on which start and end times will be placed
            var startEndCircleRadius = spinnerRadius - startEndFontSize;

            // apply computed values
            document.getElementById("spinner").setAttribute("stroke-width", spinnerArcThickness);
            document.getElementById("spinner-background").setAttribute("stroke-width", spinnerBackgroundArcThickness);
            document.getElementById("remaining").setAttribute("font-size", remainingFontSize);
            document.getElementById("remaining").setAttribute("x", spinnerX);
            document.getElementById("remaining").setAttribute("y", remainingY);
            document.getElementById("remaining-above").setAttribute("font-size", remainingAboveFontSize);
            document.getElementById("remaining-above").innerHTML = remainingAboveContent;
            document.getElementById("remaining-above").setAttribute("x", spinnerX);
            document.getElementById("remaining-above").setAttribute("y", remainingAboveY);
            document.getElementById("remaining-below").setAttribute("font-size", remainingBelowFontSize);
            document.getElementById("remaining-below").innerHTML = remainingBelowContent;
            document.getElementById("remaining-below").setAttribute("x", spinnerX);
            document.getElementById("remaining-below").setAttribute("y", remainingBelowY);
            document.getElementById("start-end-circle").setAttribute("d", describeArc(spinnerX, spinnerY, startEndCircleRadius, 0, 359.999));
            document.getElementById("start-end").setAttribute("font-size", startEndFontSize);
            document.getElementById("start-end").setAttribute("x", Math.PI * startEndCircleRadius);

            if (!running) {
                document.getElementById("timer").style.opacity = 0.666;

                // if timer not yet running: show total time
                document.getElementById("spinner").setAttribute("d", describeArc(spinnerX, spinnerY, spinnerRadius, 0, 359.999));
                document.getElementById("spinner-background").setAttribute("d", describeArc(spinnerX, spinnerY, spinnerRadius, 0, 359.999));
                document.getElementById("remaining").innerHTML = duration + remainingLabel;

            } else {
                // if timer running: set start and end times and update timer
                document.getElementById("start-end-path").innerHTML = startContent + ": " + s.toTimeString().substring(0,5) + " – " + endContent + ": " + e.toTimeString().substring(0,5);

                // tick, tock, tick, tock, ...
                var remaining = Math.max(e.getTime() - (new Date()).getTime(), 0);
                var remainingDeg = remaining / (duration * 60 * 1000) * 360;

                if (remaining > 0) {
                    document.getElementById("timer").style.opacity = 1.0;
                } else {
                    document.getElementById("timer").style.opacity = 0.666;
                }

                document.getElementById("spinner").setAttribute("d", describeArc(spinnerX, spinnerY, spinnerRadius, 360 - remainingDeg, 360));
                document.getElementById("spinner-background").setAttribute("d", describeArc(spinnerX, spinnerY, spinnerRadius, 0, 359.999));
                document.getElementById("remaining").innerHTML = Math.ceil(remaining / (60 * 1000)) + remainingLabel;
            }

            // show and hide instructions depending on state
            var state;
            if (!running) {
                state = "before"
            } else {
                var remaining = Math.max(e.getTime() - (new Date()).getTime(), 0);
                if (remaining > 10 * 60 * 1000) {
                    state = "during"
                } else if (remaining > 0) {
                    state = "homestretch"
                } else {
                    state = "after"
                }
            }
            var otherStates = ["before", "during", "homestretch", "after"];
            otherStates.splice(otherStates.indexOf(state), 1);

            // in-active states
            for (o in otherStates) {
                var elements = document.getElementsByClassName(otherStates[o]);
                for (var i = 0; i < elements.length; i++) {
                    elements[i].style.display = "none";
                }
            }

            // active states
            var elements = document.getElementsByClassName(state);
            for (var i = 0; i < elements.length; i++) {
                elements[i].style.display = "block";
            }
        }, 100);
    </script>
</body>
</html>
